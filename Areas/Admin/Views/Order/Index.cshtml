@model IEnumerable<SmartECommerce.Models.Order>
@using SmartECommerce.Models

<h2>All Orders</h2>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" asp-action="Index">
            <div class="row g-3">

                <!-- Search -->
                <div class="col-md-3 form-floating">
                    <input type="text" name="searchString" class="form-control"
                           id="searchString"
                           value="@ViewData["CurrentFilter"]"
                           placeholder="Search customer or Order ID">
                    <label for="searchString">Search customer or Order ID</label>
                </div>

                <!-- Status Filter -->
                <div class="col-md-2 form-floating">
                    <select name="statusFilter" id="statusFilter" class="form-select">
                        <option value="All" selected="@(ViewData["StatusFilter"]?.ToString() == "All")">All Status</option>
                        @foreach (OrderStatus status in Enum.GetValues(typeof(OrderStatus)))
                        {
                            <option value="@status" selected="@(status.ToString() == ViewData["StatusFilter"]?.ToString())">
                                @status
                            </option>
                        }
                    </select>
                    <label for="statusFilter">Status</label>
                </div>

                <!-- Payment Method Filter -->
                <div class="col-md-2 form-floating">
                    <select name="paymentMethod" id="paymentMethod" class="form-select">
                        <option value="All" selected="@(ViewData["PaymentMethod"]?.ToString() == "All")">All Payments</option>
                        @foreach (PaymentMethod pm in Enum.GetValues(typeof(PaymentMethod)))
                        {
                            <option value="@pm" selected="@(pm.ToString() == ViewData["PaymentMethod"]?.ToString())">
                                @pm
                            </option>
                        }
                    </select>
                    <label for="paymentMethod">Payment Method</label>
                </div>

                <!-- From Date -->
                <div class="col-md-2 form-floating">
                    <input type="date" name="fromDate" class="form-control" 
                           id="fromDate"
                           value="@ViewData["FromDate"]" 
                           placeholder="From Date">
                    <label for="fromDate">From Date</label>
                </div>

                <!-- To Date -->
                <div class="col-md-2 form-floating">
                    <input type="date" name="toDate" class="form-control" 
                           id="toDate"
                           value="@ViewData["ToDate"]" 
                           placeholder="To Date">
                    <label for="toDate">To Date</label>
                </div>

                <!-- Filter Button -->
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>

            </div>
        </form>
    </div>
</div>



<!-- Results -->
@if (!Model.Any())
{
    <div class="alert alert-info">No orders found matching your criteria.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Order ID</th>
                    <th>
                        Customer
                        <a asp-action="Index" asp-route-sortOrder="@ViewData["CustomerSortParm"]"
                           class="text-white small">↕</a>
                    </th>
                    <th>
                        Date
                        <a asp-action="Index" asp-route-sortOrder="@ViewData["DateSortParm"]"
                           class="text-white small">↕</a>
                    </th>
                    <th>
                        Total
                        <a asp-action="Index" asp-route-sortOrder="@ViewData["TotalSortParm"]"
                           class="text-white small">↕</a>
                    </th>
                    <th>Status</th>
                    <th>Order Placed Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model)
                {
                    <tr>
                        <td><strong>#@order.Id</strong></td>
                        <td>@(order.User?.UserName ?? "N/A")</td>
                        <td>@order.OrderPlacedAt?.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")</td>
                        <td><strong>$@order.TotalAmount.ToString("0.00")</strong></td>
                        <td>
                            @switch (order.Status)
                            {
                                case OrderStatus.OrderPlaced:
                                    <span class="badge bg-warning text-dark fs-6">Order Placed</span>
                                    break;
                                case OrderStatus.Processing:
                                    <span class="badge bg-info fs-6">Processing</span>
                                    break;
                                case OrderStatus.Completed:
                                    <span class="badge bg-success fs-6">Completed</span>
                                    break;
                                case OrderStatus.Cancelled:
                                    <span class="badge bg-danger fs-6">Cancelled</span>
                                    break;
                            }
                        </td>
                        <td>
                            @if (order.Status == OrderStatus.OrderPlaced)
                            {
                                var timeDiff = DateTime.UtcNow - order.OrderPlacedAt;
                                var totalDays = (int)timeDiff?.TotalDays;
                                var totalHours = (int)timeDiff?.TotalHours;

                                string pendingText;

                                if(totalDays < 1)
                                {
                                    pendingText = totalHours < 1 ? "Less than 1 hour" : $"{totalHours} hr{(totalHours > 1 ? "s" : "")}";
                                }
                                else if (totalDays < 3)
                                {
                                    var hoursPart = totalHours % 24;
                                    pendingText = hoursPart == 0
                                        ? $"{totalDays} day{(totalDays > 1 ? "s" : "")}"
                                        : $"{totalDays} day{(totalDays > 1 ? "s" : "")} {hoursPart} hr {(hoursPart > 1 ? "s" : "")}";
                                }
                                else
                                {
                                    pendingText = $"{totalDays} day{(totalDays > 1 ? "s" : "")}";
                                }

                                <span class="badge @(totalDays >= 3 ? "bg-danger" : "bg-warning")">
                                    @(totalDays >= 3 ? "🚨 " : "")@pendingText
                                </span>
                            }
                            else
                            {
                                <span class="text-muted small">-</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a asp-action="Details" asp-route-id="@order.Id"
                                   class="btn btn-sm btn-outline-primary">View</a>
                                <a asp-action="UpdateStatus" asp-route-id="@order.Id"
                                   class="btn btn-sm btn-outline-warning">Status</a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
